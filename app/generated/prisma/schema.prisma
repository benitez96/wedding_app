generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Invitaciones principales
model Invitation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Información de la invitación
  guestName     String
  guestNickname String?
  guestPhone    String?
  maxGuests     Int     @default(1)

  // Respuesta del invitado
  hasResponded Boolean   @default(false)
  isAttending  Boolean?
  guestCount   Int?
  respondedAt  DateTime?

  // Relaciones
  tokens InvitationToken[]

  @@map("invitations")
}

// Tokens únicos para cada invitación
model InvitationToken {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Estado del token (se puede revocar sin eliminar)
  isActive Boolean @default(true)
  isUsed   Boolean @default(false)

  // Información de uso del token
  firstAccessAt DateTime?
  lastAccessAt  DateTime?
  deviceId      String?
  userAgent     String?
  accessCount   Int       @default(0)

  // Relaciones
  invitationId String
  invitation   Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@map("invitation_tokens")
}

// Usuarios del backoffice (administradores)
model AdminUser {
  id String @id @default(cuid())

  // Información del usuario
  username String @unique
  password String

  @@map("admin_users")
}

// Rate limiting - Intentos de acceso
model RateLimitAttempt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Información del intento
  ip         String
  actionType String // 'invitation-token', 'admin-login', 'invitation-actions'
  success    Boolean  @default(false)
  timestamp  DateTime @default(now())

  @@map("rate_limit_attempts")
}

// Rate limiting - Bloqueos de IP
model RateLimitBlock {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Información del bloqueo
  ip           String
  actionType   String // 'invitation-token', 'admin-login', 'invitation-actions'
  blockedUntil DateTime
  reason       String?

  @@map("rate_limit_blocks")
}
